var dishes = [
    {
        id: 'mixed-tomato-canapes',
        name: 'Mixed Tomato Canapes',
        description: 'For a quick and easy bite-size snack, serve these tasty mixed tomato canapés with melted camembert and basil pesto.',
        tags: [
            'Contains Gluten',
            'Contains Peanuts',
            'Contains Tree Nuts',
            'Contains Milk',
            'Contains Soy',
        ],
        fields: `
        <b>Ingredients</b>
        <p>200g red Perino tomatoes<br>200g gold Perino tomatoes<br>1 tsp olive oil<br>1 Coles Bakery stone baked wholemeal quinoa pane di casa bread, cut into 1cm-thick slices<br>Olive oil, to brush<br>1/3 cup (90g) basil pesto<br>100g camembert, cut into thin slices<br>Fresh basil leaves, to serve</p>
        <b>Serves</b>
        <p>15</p>
        `,
        imageURL: '/static/images/1.jpeg',
        reviews: [
            {
                starRating: 4,
                review: 'Test',
            },
        ],
    },
    {
        id: 'celery-lemon-parsley-spoon-salad',
        name: 'Celery, Lemon and Parsley Spoon Salad',
        description: 'Take a cue from Turkey’s lovely tomato and cucumber ‘spoon salad’, and finely dice crisp summer vegetables, as you would for a salsa. Serve with spoons to make serving and eating easier.',
        tags: ['Contains Tree Nuts', 'Contains Celery'],
        fields: `
        <b>Ingredients</b>
        <p>2 celery stalks<br>1/2 telegraph cucumber, peeled, seeds removed, cut into 5mm cubes<br>Zested rind of 2 lemons, plus 2 tbsp juice<br>1/3 cup finely chopped flat-leaf parsley leaves<br>1 tbsp baby salted capers, rinsed<br>1 tbsp finely chopped toasted pecans<br>1/4 cup (60ml) extra virgin olive oil</p>
        <b>Serves</b>
        <p>4</p>
        `,
        imageURL: '/static/images/2.jpeg',
        reviews: [
            {
                starRating: 1,
                review: 'Testing',
            },
        ],
    },
    {
        id: 'mixed-tomato-canapes',
        name: 'Mixed Tomato Canapes',
        description: 'For a quick and easy bite-size snack, serve these tasty mixed tomato canapés with melted camembert and basil pesto.',
        tags: [
            'Contains Gluten',
            'Contains Peanuts',
            'Contains Tree Nuts',
            'Contains Milk',
            'Contains Soy',
        ],
        fields: `
        <b>Ingredients</b>
        <p>200g red Perino tomatoes<br>200g gold Perino tomatoes<br>1 tsp olive oil<br>1 Coles Bakery stone baked wholemeal quinoa pane di casa bread, cut into 1cm-thick slices<br>Olive oil, to brush<br>1/3 cup (90g) basil pesto<br>100g camembert, cut into thin slices<br>Fresh basil leaves, to serve</p>
        <b>Serves</b>
        <p>15</p>
        `,
        imageURL: '/static/images/3.jpeg',
        reviews: [
            {
                starRating: 4,
                review: 'Test',
            },
        ],
    },
    {
        id: 'mixed-tomato-canapes',
        name: 'Mixed Tomato Canapes',
        description: 'For a quick and easy bite-size snack, serve these tasty mixed tomato canapés with melted camembert and basil pesto.',
        tags: [
            'Contains Gluten',
            'Contains Peanuts',
            'Contains Tree Nuts',
            'Contains Milk',
            'Contains Soy',
        ],
        fields: `
        <b>Ingredients</b>
        <p>200g red Perino tomatoes<br>200g gold Perino tomatoes<br>1 tsp olive oil<br>1 Coles Bakery stone baked wholemeal quinoa pane di casa bread, cut into 1cm-thick slices<br>Olive oil, to brush<br>1/3 cup (90g) basil pesto<br>100g camembert, cut into thin slices<br>Fresh basil leaves, to serve</p>
        <b>Serves</b>
        <p>15</p>
        `,
        imageURL: '/static/images/4.jpeg',
        reviews: [
            {
                starRating: 4,
                review: 'Test',
            },
        ],
    },
    {
        id: 'mixed-tomato-canapes',
        name: 'Mixed Tomato Canapes',
        description: 'For a quick and easy bite-size snack, serve these tasty mixed tomato canapés with melted camembert and basil pesto.',
        tags: [
            'Contains Gluten',
            'Contains Peanuts',
            'Contains Tree Nuts',
            'Contains Milk',
            'Contains Soy',
        ],
        fields: `
        <b>Ingredients</b>
        <p>200g red Perino tomatoes<br>200g gold Perino tomatoes<br>1 tsp olive oil<br>1 Coles Bakery stone baked wholemeal quinoa pane di casa bread, cut into 1cm-thick slices<br>Olive oil, to brush<br>1/3 cup (90g) basil pesto<br>100g camembert, cut into thin slices<br>Fresh basil leaves, to serve</p>
        <b>Serves</b>
        <p>15</p>
        `,
        imageURL: '/static/images/5.jpeg',
        reviews: [
            {
                starRating: 4,
                review: 'Test',
            },
        ],
    },
    {
        id: 'mixed-tomato-canapes',
        name: 'Mixed Tomato Canapes',
        description: 'For a quick and easy bite-size snack, serve these tasty mixed tomato canapés with melted camembert and basil pesto.',
        tags: [
            'Contains Gluten',
            'Contains Peanuts',
            'Contains Tree Nuts',
            'Contains Milk',
            'Contains Soy',
        ],
        fields: `
        <b>Ingredients</b>
        <p>200g red Perino tomatoes<br>200g gold Perino tomatoes<br>1 tsp olive oil<br>1 Coles Bakery stone baked wholemeal quinoa pane di casa bread, cut into 1cm-thick slices<br>Olive oil, to brush<br>1/3 cup (90g) basil pesto<br>100g camembert, cut into thin slices<br>Fresh basil leaves, to serve</p>
        <b>Serves</b>
        <p>15</p>
        `,
        imageURL: '/static/images/6.jpeg',
        reviews: [
            {
                starRating: 4,
                review: 'Test',
            },
        ],
    },
    {
        id: 'mixed-tomato-canapes',
        name: 'Mixed Tomato Canapes',
        description: 'For a quick and easy bite-size snack, serve these tasty mixed tomato canapés with melted camembert and basil pesto.',
        tags: [
            'Contains Gluten',
            'Contains Peanuts',
            'Contains Tree Nuts',
            'Contains Milk',
            'Contains Soy',
        ],
        fields: `
        <b>Ingredients</b>
        <p>200g red Perino tomatoes<br>200g gold Perino tomatoes<br>1 tsp olive oil<br>1 Coles Bakery stone baked wholemeal quinoa pane di casa bread, cut into 1cm-thick slices<br>Olive oil, to brush<br>1/3 cup (90g) basil pesto<br>100g camembert, cut into thin slices<br>Fresh basil leaves, to serve</p>
        <b>Serves</b>
        <p>15</p>
        `,
        imageURL: '/static/images/7.jpeg',
        reviews: [
            {
                starRating: 4,
                review: 'Test',
            },
        ],
    },
    {
        id: 'random',
        name: 'Mixed Tomato Canapes',
        description: 'For a quick and easy bite-size snack, serve these tasty mixed tomato canapés with melted camembert and basil pesto.',
        tags: [
            'Contains Gluten',
            'Contains Peanuts',
            'Contains Tree Nuts',
            'Contains Milk',
            'Contains Soy',
        ],
        fields: `
        <b>Ingredients</b>
        <p>200g red Perino tomatoes<br>200g gold Perino tomatoes<br>1 tsp olive oil<br>1 Coles Bakery stone baked wholemeal quinoa pane di casa bread, cut into 1cm-thick slices<br>Olive oil, to brush<br>1/3 cup (90g) basil pesto<br>100g camembert, cut into thin slices<br>Fresh basil leaves, to serve</p>
        <b>Serves</b>
        <p>15</p>
        `,
        imageURL: '/static/images/8.jpeg',
        reviews: [
            {
                starRating: 4,
                review: 'Test',
            },
        ],
    },
];
var tz;
var carouselIndex = 0;
function loadContent() {
    console.log(window['dishes-server']);
    dishes = JSON.parse(window['dishes-server']);
    if (window['product'] != '') {
        carouselIndex = dishes.findIndex(dish => {
            return dish.id == window['product'];
        });
    }
    var carousel = document.querySelector('#carousel');
    carousel.replaceChildren();
    for (var dish of dishes) {
        var carouselCell = document.createElement('div');
        carouselCell.className = 'carousel-cell';
        carouselCell['style'].backgroundImage = 'url("' + dish.imageURL + '")';
        carousel.appendChild(carouselCell);
    }
    document.querySelector('#dish-name')['innerText'] =
        dishes[carouselIndex].name;
    document.querySelector('#dish-description')['innerText'] =
        dishes[carouselIndex].description;
    document.querySelector('#dish-tags').innerHTML =
        '<span>' + dishes[0].tags.join('</span><span>') + '</span>';
    document.querySelector('#dish-fields').innerHTML =
        dishes[carouselIndex].fields;
    if (window['reviews'] == 'SHOW') {
        console.log(carouselIndex);
        history.replaceState({ command: 'rotateCarousel', index: carouselIndex * -1 }, '', '');
        history.pushState({ command: 'reviews', subcommand: 'show' }, '', '');
        document.querySelector('#reviews-wrapper')['style'].display = 'block';
        document.querySelector('#reviews-wrapper')['style'].opacity = '1';
        document.querySelector('#review-form')['action'] =
            location.pathname + '/submit';
    }
    else {
        history.replaceState({ command: 'rotateCarousel', index: carouselIndex }, '', '/' + dishes[carouselIndex].id);
    }
    var reviewsHTML = '';
    for (var review of dishes[carouselIndex].reviews) {
        reviewsHTML +=
            `
            <div class="review">
                <div class="star-rating">` +
                '★'.repeat(review.starRating) +
                '☆'.repeat(5 - review.starRating) +
                ` &ndash; ` +
                review.starRating +
                `/5 stars
                </div>
                <div class="review-body">
                    ` +
                review.review +
                `
                </div>
            </div>
        `;
    }
    document.querySelector('#reviews-popup-customer-reviews').innerHTML =
        `
    <div class="reviews-popup-subtitle">Reviews</div>
    ` +
            reviewsHTML +
            `
    `;
    carouselIndex = carouselIndex * -1;
}
function layoutCarousel() {
    var numberOfCells = dishes.length;
    var cellSize = document.querySelectorAll('.carousel-cell')[0].getBoundingClientRect()
        .height + (window.innerWidth > 768 ? 40 : 20);
    console.log(cellSize);
    tz = Math.round(cellSize / 2 / Math.tan((Math.PI * 2) / numberOfCells / 2));
    document.querySelector('#carousel')['style'].transform =
        'translateZ(-' +
            tz +
            'px) rotateX(' +
            (360 / numberOfCells) * carouselIndex +
            'deg)';
    var i = 0;
    document.querySelectorAll('.carousel-cell').forEach(cell => {
        cell['style'].transform =
            'rotateX(' +
                (360 / numberOfCells) * i +
                'deg) translateZ(' +
                tz +
                'px)';
        i += 1;
    });
    document.querySelector('#carousel')['style'].transition = 'transform 1s';
}
function rotateCarousel(diff, pushState = true) {
    carouselIndex += diff;
    var clampedCarouselIndex;
    var copiedCarouselIndex = carouselIndex;
    if (copiedCarouselIndex < 0) {
        clampedCarouselIndex = dishes.length;
        while (copiedCarouselIndex != 0) {
            if (clampedCarouselIndex == 0) {
                clampedCarouselIndex = dishes.length - 1;
            }
            else {
                clampedCarouselIndex -= 1;
            }
            copiedCarouselIndex += 1;
        }
    }
    else {
        clampedCarouselIndex = 0;
        while (copiedCarouselIndex != 0) {
            if (clampedCarouselIndex == dishes.length - 1) {
                clampedCarouselIndex = 0;
            }
            else {
                clampedCarouselIndex += 1;
            }
            copiedCarouselIndex -= 1;
        }
    }
    if (clampedCarouselIndex != 0) {
        clampedCarouselIndex = dishes.length - clampedCarouselIndex;
    }
    document.querySelector('#carousel')['style'].transform =
        'translateZ(-' +
            tz +
            'px) rotateX(' +
            (360 / dishes.length) * carouselIndex +
            'deg)';
    document.querySelector('#dish-body')['style'].opacity = '0';
    setTimeout(() => {
        document.querySelector('#dish-name')['innerText'] =
            dishes[clampedCarouselIndex].name;
        document.querySelector('#dish-description')['innerText'] =
            dishes[clampedCarouselIndex].description;
        document.querySelector('#dish-tags').innerHTML =
            '<span>' +
                dishes[clampedCarouselIndex].tags.join('</span><span>') +
                '</span>';
        document.querySelector('#dish-fields').innerHTML =
            dishes[clampedCarouselIndex].fields;
        document.querySelector('#dish-body')['style'].opacity = '1';
    }, 500);
    if (pushState) {
        history.pushState({ command: 'rotateCarousel', index: carouselIndex }, '', '/' + dishes[clampedCarouselIndex].id);
    }
    var reviewsHTML = '';
    for (var review of dishes[clampedCarouselIndex].reviews) {
        reviewsHTML +=
            `
            <div class="review">
                <div class="star-rating">` +
                '★'.repeat(review.starRating) +
                '☆'.repeat(5 - review.starRating) +
                ` &ndash; ` +
                review.starRating +
                `/5 stars
                </div>
                <div class="review-body">
                    ` +
                review.review +
                `
                </div>
            </div>
        `;
    }
    document.querySelector('#reviews-popup-customer-reviews').innerHTML =
        `
    <div class="reviews-popup-subtitle">Reviews</div>
    ` +
            reviewsHTML +
            `
    `;
}
loadContent();
window.addEventListener('load', () => {
    layoutCarousel();
});
var scrollingCarousel = false;
var scrollingCarouselStartX = 0;
var scrollingCarouselStartY = 0;
document
    .querySelector('#body')
    .addEventListener('touchstart', (e) => {
    var imageScrollerClientRect = document
        .querySelector('#image-scroller-gradient-overlay')
        .getBoundingClientRect();
    if (imageScrollerClientRect.left < e.changedTouches[0].clientX &&
        e.changedTouches[0].clientX < imageScrollerClientRect.right &&
        imageScrollerClientRect.top < e.changedTouches[0].clientY &&
        e.changedTouches[0].clientY < imageScrollerClientRect.bottom) {
        document.querySelector('#image-scroller-swipe-hint')['style'].opacity = '0';
        scrollingCarousel = true;
        scrollingCarouselStartX = e.changedTouches[0].clientX;
        scrollingCarouselStartY = e.changedTouches[0].clientY;
        e.preventDefault();
    }
    else {
        scrollingCarousel = false;
    }
});
document
    .querySelector('#body')
    .addEventListener('touchend', (e) => {
    if (scrollingCarousel) {
        scrollingCarousel = !scrollingCarousel;
        if (Math.abs(scrollingCarouselStartY - e.changedTouches[0].clientY) > 50) {
            if (scrollingCarouselStartY < e.changedTouches[0].clientY) {
                console.log('Scroll: UP');
                rotateCarousel(-1);
            }
            else if (scrollingCarouselStartY > e.changedTouches[0].clientY) {
                console.log('Scroll: DOWN');
                rotateCarousel(1);
            }
        }
    }
    //console.log(e.changedTouches[0].screenX)
});
document.querySelector('#body').addEventListener('click', (e) => {
    var upButtonClientRect = document
        .querySelector('#image-scroller-up-button-wrapper')
        .getBoundingClientRect();
    if (upButtonClientRect.left < e.clientX &&
        e.clientX < upButtonClientRect.right &&
        upButtonClientRect.top < e.clientY &&
        e.clientY < upButtonClientRect.bottom) {
        rotateCarousel(-1);
    }
    var downButtonClientRect = document
        .querySelector('#image-scroller-down-button-wrapper')
        .getBoundingClientRect();
    if (downButtonClientRect.left < e.clientX &&
        e.clientX < downButtonClientRect.right &&
        downButtonClientRect.top < e.clientY &&
        e.clientY < downButtonClientRect.bottom) {
        rotateCarousel(1);
    }
});
document.querySelector('#button-desktop').addEventListener('click', () => {
    history.pushState({ command: 'reviews', subcommand: 'show' }, '', location.pathname.split('/')[location.pathname.split('/').length - 1] +
        '/reviews');
    document.querySelector('#reviews-wrapper')['style'].display = 'block';
    setTimeout(() => {
        document.querySelector('#reviews-wrapper')['style'].opacity = '1';
    }, 10);
    document.querySelector('#review-form')['action'] =
        location.pathname + '/submit';
});
document.querySelector('#button-mobile').addEventListener('click', () => {
    history.pushState({ command: 'reviews', subcommand: 'show' }, '', location.pathname.split('/')[location.pathname.split('/').length - 1] +
        '/reviews');
    document.querySelector('#reviews-wrapper')['style'].display = 'block';
    setTimeout(() => {
        document.querySelector('#reviews-wrapper')['style'].opacity = '1';
    }, 10);
    document.querySelector('#review-form')['action'] =
        location.pathname + '/submit';
});
document
    .querySelector('#reviews-popup-close-button')
    .addEventListener('click', () => {
    history.back();
});
setTimeout(() => {
    document.querySelector('#image-scroller-swipe-hint')['style'].opacity = '0';
}, 4000);
window.onpopstate = (e) => {
    console.log(e.state);
    console.log(history.state);
    if (e.state['command'] == 'rotateCarousel') {
        if (e.state['index'] != carouselIndex) {
            rotateCarousel(e.state['index'] - carouselIndex, false);
        }
    }
    if (document.querySelector('#reviews-wrapper')['style'].display != 'none') {
        console.log('hh');
        document.querySelector('#reviews-wrapper')['style'].opacity = '0';
        setTimeout(() => {
            document.querySelector('#reviews-wrapper')['style'].display = 'none';
        }, 200);
        if (window['reviews'] == 'SHOW') {
            history.pushState({ command: '' }, '', '/' +
                location.pathname.split('/')[location.pathname.split('/').length - 2]);
        }
    }
};
